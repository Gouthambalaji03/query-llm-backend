# Query LLM Backend - Claude Rules

## Project Context
This is a Node.js/Express TypeScript API server using MongoDB, Firebase Auth, and Zod validation.

## Cross-Repo Links
- Root index: `AGENTS.md`

## Critical Conventions

### snake_case Everywhere
- **Files**: `user_controller.ts`, `auth_middleware.ts`
- **Variables**: `user_data`, `is_authenticated`, `token_payload`
- **Functions**: `get_user_by_id()`, `validate_request()`, `send_response()`
- **Types/Interfaces**: `authenticated_request`, `api_response`, `user_document`
- **Database fields**: `created_at`, `updated_at`
- **Constants**: `MAX_PAGE_SIZE`, `DEFAULT_TIMEOUT`

### Layer Responsibilities
| Layer | Responsibility |
|-------|---------------|
| Routes | Define endpoints, apply middleware |
| Controllers | Handle HTTP, delegate to services |
| Services | Business logic, database operations |
| Models | Schema definition, data shape |
| Schemas | Zod input validation |
| Middlewares | Auth, validation, error handling |

## Standard Patterns

### New Endpoint Checklist
1. Add Zod schema inline with the controller
2. Add controller function in `src/controllers/`
3. Add route with `auth_middleware` in `src/routes/`

### Zod Validation Template
```typescript
export const {action}_{entity}_body_schema = z.object({
  /* fields */
});
```

### Controller Template
```typescript
export const {action}_{entity} = async_handler(async (
  req: Request,
  res: Response
): Promise<void> => {
  // validate, operate, respond
});
```

### Route Template
```typescript
router.{method}(
  '/{path}',
  auth_middleware,
  {entity}_controller.{action}_{entity}
);
```

## Error Handling

Use `api_error` static methods:
- `api_error.bad_request(message, details?)` - 400
- `api_error.unauthorized(message?)` - 401
- `api_error.forbidden(message?)` - 403
- `api_error.not_found(message?)` - 404
- `api_error.conflict(message, details?)` - 409
- `api_error.validation_error(message, details?)` - 422
- `api_error.internal_error(message?)` - 500

## API Response Helpers
Use direct `res.status(...).json(...)` responses.

## Database Conventions

### Mongoose Schema
```typescript
const {entity}_schema = new Schema<{entity}_document>(
  {
    field_name: { type: String, required: true },
  },
  {
    timestamps: { createdAt: 'created_at', updatedAt: 'updated_at' },
    toJSON: { transform: (_doc, ret) => { ret.id = ret._id; delete ret._id; delete ret.__v; } }
  }
);
```

### Indexes
- Add `unique: true` and `index: true` for fields used in lookups

## Common Gotchas

1. **Use `.lean()`** for reads and return plain objects
2. **Never skip validation** - always use inline Zod
3. **Protected routes** need `auth_middleware` before other middleware
4. **Check uniqueness** before creating/updating
5. **Do not use `toJSON()`** in controllers

## SOP Updates
- Create/Update/Delete endpoints must not return `data` in the response.
- `/api/auth/me` is removed; use `GET /api/users/:user_id`.
- Message creation uses `PATCH /api/conversations/:conversation_id` with `message` payload.

## File Locations Quick Reference
- Types: `src/types/index.ts`
- Error class: `src/utils/api_error.ts`
- Response helpers: `src/utils/api_response.ts`
- Env config: `src/config/env.ts`
- DB connection: `src/config/database.ts`
- Firebase setup: `src/config/firebase.ts`
